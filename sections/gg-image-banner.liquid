{{ 'gg-section-image-banner.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign video_id = section.settings.video.id | default: section.settings.video_url.id
  assign video_alt = section.settings.video.alt | default: section.settings.description
-%}

<div class="gg-banner-container">
  {%- if section.settings.image != blank -%}
    <div class="gg-banner-image">
      {%- assign image_height = section.settings.image_height | default: 'medium' -%}
      {{ section.settings.image | image_url: width: 3840 | image_tag:
        loading: 'eager',
        width: section.settings.image.width,
        height: section.settings.image.height,
        class: "banner__media-image",
        sizes: "100vw"
      }}
    </div>
  {%- endif -%}

  {%- if section.settings.video != blank or section.settings.video_url != blank -%}
    <div class="gg-banner-video" style="display: none;">
      {%- if section.settings.video == null and section.settings.video_url != null -%}
        {%- if section.settings.video_url.type == 'youtube' -%}
          <iframe
            id="banner-video"
            src="https://www.youtube.com/embed/{{ video_id }}?enablejsapi=1&autoplay=1&loop=1&playlist={{ video_id }}&mute=1"
            class="js-youtube"
            allow="autoplay; encrypted-media"
            allowfullscreen
            title="{{ section.settings.description | escape }}"
          ></iframe>
        {%- else -%}
          <iframe
            id="banner-video"
            src="https://player.vimeo.com/video/{{ video_id }}?autoplay=1&loop=1&muted=1"
            class="js-vimeo"
            allow="autoplay; encrypted-media"
            allowfullscreen
            title="{{ section.settings.description | escape }}"
          ></iframe>
        {%- endif -%}
      {%- else -%}
        {{
          section.settings.video
          | video_tag:
            id: 'banner-video',
            autoplay: true,
            loop: true,
            muted: true,
            playsinline: true,
            controls: false
        }}
      {%- endif -%}
    </div>
  {%- endif -%}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('banner-video');
    const imageContainer = document.querySelector('.gg-banner-image');
    const videoContainer = document.querySelector('.gg-banner-video');

    if (video) {
      video.addEventListener('error', function(e) {
        console.error('Video loading error:', e);
        if (imageContainer) {
          imageContainer.style.display = 'block';
        }
      });

      if (video.readyState >= 3) {
        if (imageContainer) {
          imageContainer.style.display = 'none';
        }
        if (videoContainer) {
          videoContainer.style.display = 'block';
        }
      }

      video.addEventListener('loadeddata', function() {
        if (imageContainer) {
          imageContainer.style.display = 'none';
        }
        if (videoContainer) {
          videoContainer.style.display = 'block';
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "GG Image Banner",
  "settings": [
    {
      "type": "image_picker",
      "id": "image",
      "label": "Banner Image"
    },
    {
      "type": "header",
      "content": "Video"
    },
    {
      "type": "video",
      "id": "video",
      "label": "Video file"
    },
    {
      "type": "video_url",
      "id": "video_url",
      "accept": ["youtube", "vimeo"],
      "label": "Video URL",
      "info": "Support YouTube or Vimeo URL"
    },
    {
      "type": "text",
      "id": "description",
      "label": "Video description",
      "info": "Description for accessibility"
    },
    {
      "type": "select",
      "id": "image_height",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ],
      "default": "medium",
      "label": "Banner Height"
    }
  ],
  "presets": [
    {
      "name": "GG Image Banner"
    }
  ]
}
{% endschema %}
